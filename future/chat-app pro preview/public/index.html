<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare å…è´¹èŠå¤©å®¤</title>
    <style>
        :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0; --accent: #f6821f; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; height: 100vh; }
        #app { width: 100%; max-width: 600px; display: flex; flex-direction: column; background: var(--card); height: 100%; border-left: 1px solid #444; border-right: 1px solid #444; }
        header { padding: 15px; background: #00000050; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 8px 12px; border-radius: 8px; background: #3d3d3d; max-width: 80%; word-wrap: break-word; }
        .message.mine { align-self: flex-end; background: #00509e; }
        .meta { font-size: 0.75em; color: #888; margin-bottom: 4px; }
        #input-area { padding: 15px; border-top: 1px solid #444; display: flex; gap: 10px; background: #252525; }
        input { background: #1a1a1a; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; outline: none; }
        #username { width: 80px; }
        #content { flex: 1; }
        button { background: var(--accent); border: none; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <span>ğŸ’¬ å…¬å…±èŠå¤©å®¤</span>
            <span id="status" style="font-size:12px; color:lime;">â— åœ¨çº¿</span>
        </header>
        <div id="chat-box">
            <div style="text-align:center; color:#666; margin-top:20px;">åŠ è½½ä¸­...</div>
        </div>
        <form id="input-area">
            <input type="text" id="username" placeholder="æ˜µç§°" required maxlength="10">
            <input type="text" id="content" placeholder="è¾“å…¥æ¶ˆæ¯..." required autocomplete="off">
            <button type="submit" id="send-btn">å‘é€</button>
        </form>
    </div>

    <script>
        const API_URL = "/api/messages"; // ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨åŒ¹é…å½“å‰åŸŸå
        const chatBox = document.getElementById('chat-box');
        const form = document.getElementById('input-area');
        const userDetails = localStorage.getItem('chat_user') || `è®¿å®¢${Math.floor(Math.random()*1000)}`;
        document.getElementById('username').value = userDetails;

        let lastMessageTime = 0;

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(ts) {
            return new Date(ts).toLocaleTimeString();
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(messages) {
            // å¦‚æœæ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œä¸é‡ç»˜ï¼ˆç®€å•ä¼˜åŒ–ï¼‰
            if (messages.length > 0 && messages[messages.length-1].created_at <= lastMessageTime) return;
            
            chatBox.innerHTML = messages.map(msg => {
                const isMine = msg.username === document.getElementById('username').value;
                return `
                    <div class="message ${isMine ? 'mine' : ''}">
                        <div class="meta">${msg.username} Â· ${formatTime(msg.created_at)}</div>
                        <div class="text">${escapeHtml(msg.content)}</div>
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatBox.scrollTop = chatBox.scrollHeight;
            if(messages.length > 0) lastMessageTime = messages[messages.length-1].created_at;
        }

        // é˜²XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–æ¶ˆæ¯ (è½®è¯¢)
        async function fetchMessages() {
            try {
                const res = await fetch(API_URL);
                if (res.ok) {
                    const data = await res.json();
                    renderMessages(data);
                    document.getElementById('status').style.color = 'lime';
                }
            } catch (e) {
                console.error("Fetch error:", e);
                document.getElementById('status').style.color = 'red';
            }
        }

        // å‘é€æ¶ˆæ¯
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const content = document.getElementById('content').value;
            const btn = document.getElementById('send-btn');

            if(!content.trim()) return;

            localStorage.setItem('chat_user', username);
            btn.disabled = true;
            btn.innerText = "å‘é€ä¸­...";

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, content })
                });
                if (res.ok) {
                    document.getElementById('content').value = '';
                    fetchMessages(); // ç«‹å³åˆ·æ–°
                } else {
                    alert('å‘é€å¤±è´¥');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            } finally {
                btn.disabled = false;
                btn.innerText = "å‘é€";
            }
        });

        // å¯åŠ¨è½®è¯¢ (æ¯2ç§’)
        setInterval(fetchMessages, 2000);
        fetchMessages();
    </script>
</body>
</html>