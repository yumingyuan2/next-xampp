<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBZå¸–å­ - ç”¨æˆ·ç«¯</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="css/talk.css">
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="../index.html" class="logo">
                    <span>ğŸ“</span>
                    <span>CBZå¸–å­</span>
                </a>
                <nav class="nav-menu">
                    <a href="index.html" class="nav-link active">æµè§ˆå¸–å­</a>
                    <a href="user/index.html" class="nav-link">å‘å¸–</a>
                    <a href="admin/index.html" class="nav-link">ç®¡ç†</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å¸–å­...">
                    <button class="btn btn-primary btn-sm" onclick="searchPosts()">æœç´¢</button>
                </div>
                <div class="filter-buttons">
                    <select class="form-select" id="sortSelect" onchange="sortPosts()">
                        <option value="latest">æœ€æ–°å‘å¸ƒ</option>
                        <option value="popular">æœ€å—æ¬¢è¿</option>
                    </select>
                    <select class="form-select" id="tagFilter" onchange="filterByTag()">
                        <option value="">æ‰€æœ‰æ ‡ç­¾</option>
                    </select>
                </div>
            </div>

            <!-- å¸–å­åˆ—è¡¨ -->
            <div class="post-list" id="postList">
                <!-- å¸–å­å°†åŠ¨æ€åŠ è½½ -->
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åˆ†é¡µå°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </main>

    <script src="../js/common.js"></script>
    <script src="js/talk.js"></script>
    <script>
        // é¡µé¢å˜é‡
        let currentPage = 1;
        const postsPerPage = 10;
        let currentPosts = [];

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadPosts();
            loadTags();
        });

        // åŠ è½½å¸–å­
        function loadPosts() {
            const options = {
                sort: document.getElementById('sortSelect').value,
                search: document.getElementById('searchInput').value,
                tag: document.getElementById('tagFilter').value
            };
            
            currentPosts = talkSystem.getPosts(options);
            renderPosts();
            renderPagination();
        }

        // æ¸²æŸ“å¸–å­
        function renderPosts() {
            const postList = document.getElementById('postList');
            const start = (currentPage - 1) * postsPerPage;
            const end = start + postsPerPage;
            const postsToShow = currentPosts.slice(start, end);

            if (postsToShow.length === 0) {
                postList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— å¸–å­</div>
                    </div>
                `;
                return;
            }

            postList.innerHTML = postsToShow.map(post => `
                <div class="post-item" onclick="viewPost(${post.id})">
                    <div class="post-header">
                        <div class="post-author">
                            <div class="author-avatar">${post.avatar}</div>
                            <div class="author-info">
                                <div class="author-name">${TalkUtils.escapeHtml(post.author)}</div>
                                <div class="post-time">${talkSystem.formatTime(post.time)}</div>
                            </div>
                        </div>
                        <div class="post-actions">
                            ${post.pinned ? '<span class="tag">ğŸ“Œ ç½®é¡¶</span>' : ''}
                        </div>
                    </div>
                    <div class="post-body">
                        <h3 class="post-title">${TalkUtils.escapeHtml(post.title)}</h3>
                        <div class="post-content">${TalkUtils.truncateText(TalkUtils.escapeHtml(post.content))}</div>
                        <div class="post-tags">
                            ${post.tags.map(tag => `<span class="tag">${TalkUtils.escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                    <div class="post-footer">
                        <div class="post-stats">
                            <div class="stat-item" onclick="event.stopPropagation(); likePost(${post.id})">
                                <span>ğŸ‘</span>
                                <span>${post.likes}</span>
                            </div>
                            <div class="stat-item">
                                <span>ğŸ’¬</span>
                                <span>${post.comments.length}</span>
                            </div>
                            <div class="stat-item">
                                <span>ğŸ‘ï¸</span>
                                <span>${post.views}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(currentPosts.length / postsPerPage);

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é¡µ
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }

            paginationHTML += `
                <button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é¡µ
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            const totalPages = Math.ceil(currentPosts.length / postsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderPosts();
            renderPagination();
            window.scrollTo(0, 0);
        }

        // æœç´¢å¸–å­
        function searchPosts() {
            currentPage = 1;
            loadPosts();
        }

        // æ’åºå¸–å­
        function sortPosts() {
            currentPage = 1;
            loadPosts();
        }

        // æŒ‰æ ‡ç­¾è¿‡æ»¤
        function filterByTag() {
            currentPage = 1;
            loadPosts();
        }

        // åŠ è½½æ ‡ç­¾
        function loadTags() {
            const tagFilter = document.getElementById('tagFilter');
            const tags = talkSystem.getAllTags();
            
            tagFilter.innerHTML = '<option value="">æ‰€æœ‰æ ‡ç­¾</option>' + 
                tags.map(tag => `<option value="${TalkUtils.escapeHtml(tag)}">${TalkUtils.escapeHtml(tag)}</option>`).join('');
        }

        // æŸ¥çœ‹å¸–å­è¯¦æƒ…
        function viewPost(postId) {
            talkSystem.incrementViews(postId);
            const post = talkSystem.getPost(postId);
            
            if (!post) return;
            
            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå¸–å­è¯¦æƒ…
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${TalkUtils.escapeHtml(post.title)}</h2>
                        <button class="btn btn-outline btn-sm" onclick="this.closest('.modal').remove()">âœ–</button>
                    </div>
                    <div class="modal-body">
                        <div class="post-detail-header">
                            <div class="post-author">
                                <div class="author-avatar">${post.avatar}</div>
                                <div class="author-info">
                                    <div class="author-name">${TalkUtils.escapeHtml(post.author)}</div>
                                    <div class="post-time">${new Date(post.time).toLocaleString('zh-CN')}</div>
                                </div>
                            </div>
                        </div>
                        <div class="post-detail-content">
                            <p>${TalkUtils.escapeHtml(post.content).replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="post-tags">
                            ${post.tags.map(tag => `<span class="tag">${TalkUtils.escapeHtml(tag)}</span>`).join('')}
                        </div>
                        <div class="post-stats">
                            <div class="stat-item">
                                <span>ğŸ‘</span>
                                <span>${post.likes}</span>
                            </div>
                            <div class="stat-item">
                                <span>ğŸ’¬</span>
                                <span>${post.comments.length}</span>
                            </div>
                            <div class="stat-item">
                                <span>ğŸ‘ï¸</span>
                                <span>${post.views}</span>
                            </div>
                        </div>
                        
                        <!-- è¯„è®ºåŒº -->
                        <div class="comments-section">
                            <h3>è¯„è®º (${post.comments.length})</h3>
                            
                            <!-- è¯„è®ºè¡¨å• -->
                            <div class="comment-form">
                                <div class="form-group">
                                    <textarea class="form-textarea" id="commentContent-${postId}" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3"></textarea>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="addComment(${postId})">å‘è¡¨è¯„è®º</button>
                            </div>
                            
                            <!-- è¯„è®ºåˆ—è¡¨ -->
                            <div class="comment-list" id="commentList-${postId}">
                                ${post.comments.map(comment => `
                                    <div class="comment-item">
                                        <div class="comment-avatar">${comment.avatar}</div>
                                        <div class="comment-content">
                                            <div class="comment-header">
                                                <span class="comment-author">${TalkUtils.escapeHtml(comment.author)}</span>
                                                <span class="comment-time">${talkSystem.formatTime(comment.time)}</span>
                                            </div>
                                            <div class="comment-text">${TalkUtils.escapeHtml(comment.content)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†æ ·å¼
            if (!document.querySelector('#modalStyles')) {
                const style = document.createElement('style');
                style.id = 'modalStyles';
                style.textContent = `
                    .modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    }
                    
                    .modal-content {
                        background: white;
                        border-radius: 1rem;
                        max-width: 800px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        margin: 20px;
                    }
                    
                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem;
                        border-bottom: 1px solid var(--border-color);
                    }
                    
                    .modal-body {
                        padding: 1.5rem;
                    }
                    
                    .post-detail-header {
                        margin-bottom: 1rem;
                    }
                    
                    .post-detail-content {
                        margin-bottom: 1rem;
                        line-height: 1.6;
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(modal);
        }

        // ç‚¹èµå¸–å­
        function likePost(postId) {
            const likes = talkSystem.likePost(postId);
            TalkUtils.showMessage('ç‚¹èµæˆåŠŸï¼', 'success');
            loadPosts(); // é‡æ–°åŠ è½½å¸–å­åˆ—è¡¨
        }

        // æ·»åŠ è¯„è®º
        function addComment(postId) {
            const content = document.getElementById(`commentContent-${postId}`).value.trim();
            
            if (!content) {
                TalkUtils.showMessage('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
                return;
            }
            
            const comment = talkSystem.addComment(postId, { content });
            
            if (comment) {
                TalkUtils.showMessage('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
                document.getElementById(`commentContent-${postId}`).value = '';
                
                // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                const post = talkSystem.getPost(postId);
                const commentList = document.getElementById(`commentList-${postId}`);
                
                commentList.innerHTML = post.comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-avatar">${c.avatar}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${TalkUtils.escapeHtml(c.author)}</span>
                                <span class="comment-time">${talkSystem.formatTime(c.time)}</span>
                            </div>
                            <div class="comment-text">${TalkUtils.escapeHtml(c.content)}</div>
                        </div>
                    </div>
                `).join('');
                
                // æ›´æ–°è¯„è®ºæ•°
                loadPosts();
            }
        }

        // ç›‘å¬Enteré”®æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPosts();
            }
        });
    </script>
</body>
</html>
